var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s}from"./phaser-UvlxNa5i.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var a=s();class i extends a.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}class r extends a.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const e=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",(t=>{e.width=4+460*t}))}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png")}create(){this.scene.start("MatchScene",{mapName:"canyon",players:{characters:[{playerRef:"01",name:"otomo",skin:"v1"}]}})}}class n extends a.Scene{constructor(){super("MainMenu"),t(this,"background"),t(this,"logo"),t(this,"title")}create(){this.background=this.add.image(512,384,"background"),this.logo=this.add.image(512,300,"logo"),this.title=this.add.text(512,460,"Main Menu",{fontFamily:"Arial Black",fontSize:38,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("MatchScene",{playerCount:2,mapName:"canyon"})}))}}const o=["left","right","up","down","jump","dash","sword","gun"],c={AIR:{FRICTION:.05,SPEED:5},GROUND:{FRICTION:.21,SPEED:2}},h=[{key:"IDLE",spriteName:"spr_idle",frameRate:7,repeat:!0,start:0,end:0},{key:"HEAD",spriteName:"spr_head",frameRate:7,repeat:!1,start:0,end:0},{key:"DEAD",spriteName:"spr_dead",frameRate:6,repeat:!1,start:0,end:1},{key:"SLICING",spriteName:"spr_slice",frameRate:7,repeat:!0,start:0,end:0},{key:"JUMPING",spriteName:"spr_jump",frameRate:12,repeat:!1,start:1,end:2},{key:"RUNNING",spriteName:"spr_running",frameRate:6,repeat:!0,start:0,end:1},{key:"LOOKING_UP",spriteName:"spr_lookup",frameRate:7,repeat:!0,start:0,end:0},{key:"LOOKING_DOWN",spriteName:"spr_lookdown",frameRate:7,repeat:!0,start:0,end:0},{key:"DEAD_NO_HEAD",spriteName:"spr_deadnohead",frameRate:6,repeat:!1,start:0,end:1},{key:"SHORT_ATTACKING_FORWARD",spriteName:"spr_shortattack",frameRate:7,repeat:!1,start:0,end:0},{key:"SHORT_ATTACKING_UP",spriteName:"spr_shortattackup",frameRate:7,repeat:!1,start:0,end:0},{key:"SHORT_ATTACKING_DOWN",spriteName:"spr_shortattackdown",frameRate:7,repeat:!1,start:0,end:0},{key:"LONG_ATTACKING_FORWARD",spriteName:"spr_longattack",frameRate:7,repeat:!1,start:0,end:0},{key:"LONG_ATTACKING_UP",spriteName:"spr_longattackup",frameRate:7,repeat:!1,start:0,end:0},{key:"LONG_ATTACKING_DOWN",spriteName:"spr_longattackdown",frameRate:7,repeat:!1,start:0,end:0}],p={},l=Object.fromEntries(["hayao","hiroshige","habuki","kurosawa","otomo"].map((e=>[e,p[e]??h])));class m{constructor({scene:e,mapName:s}){t(this,"map"),t(this,"customProps"),t(this,"spawnPoints",[]),t(this,"tilesets",[]),t(this,"ground",[]),t(this,"mapName"),t(this,"scene"),t(this,"baseMapPath","assets/maps"),t(this,"baseSpritesPath","assets/sprites/map"),this.scene=e,this.mapName=s}load(){this.loadTiledMap(),this.loadSprites()}build(){return this.createMap(),this.createWorldLayers(),this.createCollision(),this.createSpawnPoints(),this.customProps=this.getCustomProperties(),{map:this.map,props:this.customProps,spawnPoints:this.spawnPoints}}loadTiledMap(){const e=`${this.baseMapPath}/${this.mapName}.json`;this.scene.load.tilemapTiledJSON(this.mapName,e)}loadSprites(){const e=(t,s,a)=>{t===this.mapName&&((a.tilesets||[]).forEach((e=>{const t=e.name;this.scene.textures.exists(t)||this.scene.load.image(t,`${this.baseSpritesPath}/${t}.png`)})),this.scene.load.off(Phaser.Loader.Events.FILE_COMPLETE,e))};this.scene.load.on(Phaser.Loader.Events.FILE_COMPLETE,e)}createMap(){this.map=this.scene.make.tilemap({key:this.mapName}),this.tilesets=this.map.tilesets.map((e=>this.map.addTilesetImage(e.name,e.name))).filter((e=>!!e))}createMapLayer({layerGroup:e,tilesets:t}){return this.map.layers.filter((t=>t.name.startsWith(`${e}/`))).map((s=>{const a=this.map.createLayer(s.name,t,0,0);return a&&this.setLayerDepth({layerGroup:e,layer:a}),a})).filter((e=>!!e))}createWorldLayers(){this.createMapLayer({layerGroup:"background",tilesets:this.tilesets}),this.ground=this.createMapLayer({layerGroup:"ground",tilesets:this.tilesets}),this.createMapLayer({layerGroup:"foreground",tilesets:this.tilesets})}createSpawnPoints(){var e;const t=this.map.getObjectLayer("objects/spawnpoint");if(!(null==(e=null==t?void 0:t.objects)?void 0:e.length))return console.warn('The "spawnpoint" layer is missing. Using fallback.'),void(this.spawnPoints=[{x:150,y:100}]);this.spawnPoints=t.objects.map((e=>{const{x:t=0,y:s=0,width:a=0,height:i=0}=e;return{y:s+i,x:t+a/2}}))}createCollision(){const e=this.ground.filter((e=>e.layer.name.includes("platform")));(null==e?void 0:e.length)?e.forEach((e=>{e.setCollisionByProperty({collider:!0}),this.scene.matter.world.convertTilemapLayer(e)})):console.warn(`No platform layers were found to configure ${this.mapName} map collision.`)}setLayerDepth({layerGroup:e,layer:t}){const s={ground:10,background:0,foreground:30}[e];void 0!==s?t.setDepth(s):console.warn(`The "${e}" layer group does not have a configured depth.`)}getCustomProperties(){const e=this.map.properties,t={};return Array.isArray(e)?(e.forEach((e=>t[e.name]=e.value)),t):t}}const d=()=>o.reduce(((e,t)=>(e[t]=null,e)),{}),u=({player:e})=>"02"===e?{codes:{up:"UP",down:"DOWN",left:"LEFT",right:"RIGHT",jump:"NUMPAD_ONE",dash:"NUMPAD_TWO",sword:"NUMPAD_THREE",gun:"NUMPAD_FOUR"},listeners:d()}:{codes:{up:"W",down:"S",left:"A",right:"D",jump:"K",dash:"L",sword:"J",gun:"I"},listeners:d()};function y({entityType:e}){const t={player:c};return{air:{speed:t[e].AIR.SPEED,friction:t[e].AIR.FRICTION},ground:{speed:t[e].GROUND.SPEED,friction:t[e].GROUND.FRICTION}}}function f({character:e}){let t=l[e.name];return t||(console.warn(`No sprite configuration was found for character: ${e.name}.`),t=[]),{animations:t.reduce(((t,{key:s,...a})=>(t[s]={key:`${e.name}_${a.spriteName}_${e.skin}`,...a},t)),{}),flipX:null,currentState:"IDLE"}}class g{constructor({scene:e,matchConfig:s,entities:a}){t(this,"scene"),t(this,"matchConfig"),t(this,"entities"),t(this,"baseCharacterSpritesPath","assets/sprites/characters"),t(this,"tempSpawnPoints",{x:100,y:100}),this.scene=e,this.matchConfig=s,this.entities=a}load(){this.loadCharacterSprites()}build(){this.createPlayers()}loadCharacterSprites(){this.matchConfig.players.characters.forEach((e=>{const t=l[e.name];if(!t)throw new Error(`Sprite model not found for character: ${e.name}`);t.forEach((({spriteName:t})=>{const s=`${e.name}_${t}_${e.skin}`,a=`${this.baseCharacterSpritesPath}/${e.name}/${e.skin}/${t}.png`;if(!this.scene.textures.exists(s))return this.scene.load.spritesheet(s,a,{frameWidth:16,frameHeight:16})}))}))}getPlayerId(){let e=0;return this.entities.forEach((({entityId:t})=>t.startsWith("player_")?e++:null)),`player_0${e+1}`}createPlayers(){this.matchConfig.players.characters.forEach((e=>{const t=this.getPlayerId(),s=this.createPlayerSprite({character:e,options:{friction:0}}),a=this.mountPlayerEntity({entityId:t,character:e,sprite:s});this.entities.set(a.entityId,a)}))}createPlayerSprite({character:e,frame:t,options:s}){const a=`${e.name}_spr_idle_${e.skin}`,i=this.scene.matter.add.sprite(this.tempSpawnPoints.x,this.tempSpawnPoints.y,a,t,s);return i.setFixedRotation(),i.setDepth(20),i}mountPlayerEntity({entityId:e,character:t,sprite:s}){return{entityId:e,sprite:s,character:{name:t.name,skin:t.skin},input:o.reduce(((e,t)=>(e[t]=!1,e)),{}),animation:f({character:t}),movement:y({entityType:"player"}),keymap:u({player:t.playerRef})}}}class k{constructor({scene:e}){if(t(this,"scene"),!e)throw new Error("scene parameter is missing or invalid");this.scene=e}createPhaserListeners({entities:e}){const t=this.scene.input.keyboard;t&&e instanceof Map&&e.size&&e.forEach((({keymap:e})=>{e&&Object.keys(e.codes).forEach((s=>{const a=e.codes[s];e.listeners[s]=t.addKey(a)}))}))}}class N{constructor({scene:e}){if(t(this,"scene"),!e)throw new Error("scene parameter is missing or invalid");this.scene=e}update({entities:e}){if(!(e instanceof Map))throw new Error("Entities is not a Map: "+typeof e);e.forEach((({keymap:e,input:t})=>{if(e&&t)for(const[s,a]of Object.entries(e.listeners))a&&(t[s]=a.isDown)}))}}class P{constructor({scene:e}){t(this,"scene"),this.scene=e}update({entities:e}){e.forEach((({input:e,movement:t,sprite:s})=>{if(!e||!t||!(null==s?void 0:s.body))return;const a=e.left||e.right,i=e.jump;let r=0,n=s.body.velocity.y;a&&(e.left&&(r=-t.ground.speed,s.setFlipX(!0)),e.right&&(r=t.ground.speed,s.setFlipX(!1))),i&&(n=-t.air.speed),this.scene.matter.body.setVelocity(s.body,{x:r,y:n})}))}}class S{constructor({scene:e}){t(this,"scene"),this.scene=e}create({entities:e}){e.forEach((({animation:e})=>{e&&Object.values(e.animations).forEach((e=>{var t;if(this.scene.anims.exists(e.key))return;const s=(null==(t=e.frames)?void 0:t.length)?e.frames:this.scene.anims.generateFrameNumbers(e.key,{start:e.start,end:e.end});(null==s?void 0:s.length)?this.scene.anims.create({frames:s,key:e.key,frameRate:e.frameRate,repeat:e.repeat?-1:0}):console.warn(`Could not generate frames for ${e.key}. Check if it was loaded as spritesheet.`)}))}))}update({entities:e}){e.forEach((({animation:e,sprite:t})=>{var s;if(!e||!t)return;t.setFlipX(e.flipX);const a=e.animations[e.currentState];(null==a?void 0:a.key)&&((null==(s=t.anims.currentAnim)?void 0:s.key)===a.key||t.anims.play(a.key,!0))}))}}class w extends Phaser.Scene{constructor(){super("MatchScene"),t(this,"matchConfig"),t(this,"entities",new Map),t(this,"mapBuilder"),t(this,"playerBuilder"),t(this,"keymapSystem"),t(this,"inputSystem"),t(this,"movementSystem"),t(this,"animationSystem")}init(e){this.matchConfig=e,this.initializeInstances()}initializeInstances(){this.initializeSystems(),this.initializeBuilders()}initializeSystems(){this.keymapSystem=new k({scene:this}),this.inputSystem=new N({scene:this}),this.movementSystem=new P({scene:this}),this.animationSystem=new S({scene:this})}initializeBuilders(){this.mapBuilder=new m({scene:this,mapName:this.matchConfig.mapName}),this.playerBuilder=new g({scene:this,matchConfig:this.matchConfig,entities:this.entities})}preload(){this.mapBuilder.load(),this.playerBuilder.load()}create(){this.createMap(),this.createPlayers(),this.createKeyboardInputs(),this.createAnimations()}createMap(){this.mapBuilder.build()}createPlayers(){this.playerBuilder.build()}createKeyboardInputs(){this.keymapSystem.createPhaserListeners({entities:this.entities})}createAnimations(){this.animationSystem.create({entities:this.entities})}update(){this.inputSystem.update({entities:this.entities}),this.movementSystem.update({entities:this.entities}),this.animationSystem.update({entities:this.entities})}}const E={type:a.AUTO,width:352,height:240,parent:"game-container",backgroundColor:"#000000ff",physics:{default:"matter",matter:{gravity:{x:0,y:1.5},debug:!0,setBounds:{x:0,y:0,width:352,height:240,left:!0,right:!0,top:!0,bottom:!0}}},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},render:{pixelArt:!0,antialias:!1},input:{keyboard:!0},scene:[i,r,n,w]};document.addEventListener("DOMContentLoaded",(()=>{new a.Game({...E,parent:"game-container"})}));
