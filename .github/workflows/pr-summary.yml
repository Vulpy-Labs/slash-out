name: Create PR Summary

on:
  pull_request:
    types: [opened, reopened, synchronize]

  workflow_dispatch:

jobs:
  generate-summary:
    runs-on: ubuntu-slim

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout To PR Code
        uses: actions/checkout@v4

      - name: Fetch PR Diff
        id: fetch-pr-diff
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const pr_diff = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                mediaType: {
                  format: 'diff'
                }
              });

              console.log('PR Diff', pr_diff.data);

              return pr_diff.data;
            } catch (error) {
              throw new Error('Error fetching PR Diff:', error);
            };

      - name: Generate Summary
        env:
          PR_DIFF: ${{ steps.fetch-pr-diff.outputs.result }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            const diff = process.env.PR_DIFF;
            const prNumber = context.issue.number;

            const prompt = [
              'You are a helpful assistant that generates clear, concise pull request summaries for developers.',
              '',
              'Given the following pull request diff, generate a structured summary that:',
              '1. Starts with a brief one-sentence overview of what the PR accomplishes.',
              '2. Groups related changes by theme (e.g., "New workflow for PR summaries", "Workflow trigger adjustments", "Bug fixes", "Feature additions").',
              '3. Uses bullet points within each group to describe specific changes.',
              '4. Mentions specific files when relevant to the context.',
              '5. Uses clear, developer-friendly language.',
              '6. Keeps the total summary concise (aim for 150â€“300 words).',
              '7. Formats the output in Markdown with bold headers for each theme group.',
              '',
              'Here is the pull request diff:',
              '',
              diff,
            ].join('\n');

            let summary;
            try {
              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.GH_TOKEN}`,
                },
                body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 1000,
                }),
              });

              if (!response.ok) {
                throw new Error(`AI API responded with status ${response.status}: ${await response.text()}`);
              }

              const data = await response.json();

              if (!data.choices || data.choices.length === 0) {
                throw new Error('AI API returned no choices in the response.');
              }

              summary = data.choices[0].message.content;
            } catch (error) {
              throw new Error(`Failed to generate summary: ${error.message}`);
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸ¤– AI-Generated PR Summary\n\n${summary}`,
              });

              console.log('Posted PR summary comment for PR #', prNumber);
            } catch (error) {
              throw new Error(`Failed to post PR comment: ${error.message}`);
            }
