name: Client - Deploy To GitHub Pages

on: pull_request

env:
  ARTIFACT_NAME: artifact-preview-${{github.event.pull_request.number}}
  BASE_URL: https://vulpy-labs.github.io/slash-out/preview

jobs:
  prepare-client:
    runs-on: ubuntu-22.04

    steps:
      - name: Access Branch Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build Static Files
        run: |
          cd packages/client
          npm ci
          npm run build

      - name: Check Values
        run: |
          echo "Ref = ${{github.ref}}"
          echo "Base Ref = ${{github.base_ref}}"
          echo "Head Ref = ${{github.head_ref}}"
          echo "PR Number = ${{github.event.pull_request.number}}"

      - name: Upload Static Files As Artifact
        id: upload-artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # upload-pages-artifact doesn't automatically access the predifined default working directory (line 7).
          # That's why I'm using the full path below.
          # Ref: https://github.com/actions/upload-artifact/issues/232
          path: packages/client/dist
          name: ${{env.ARTIFACT_NAME}}

  deploy-client:
    runs-on: ubuntu-22.04

    permissions:
      pages: write
      contents: write

    needs: prepare-client

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          name: ${{env.ARTIFACT_NAME}}
          path: ./

      - name: List Artifact's Content (before)
        run: ls -R

      - name: Extract Artifact
        run: |
          tar xvf artifact.tar -C ./
          rm -rf artifact.tar

      - name: List Artifact's Content (after)
        run: ls -R

      - name: Deploy Client To GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          publish_branch: gh-pages
          publish_dir: ./
          destination_dir: preview/pr-${{github.event.pull_request.number}}

      - name: Output Link
        run: echo "Link = ${{env.BASE_URL}}/pr-${{github.event.pull_request.number}}"

  publish-link:
    runs-on: ubuntu-22.04

    needs: deploy-client

    steps:
      - name: Publish Link
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/`;
            const previewSection = `\n\n---\nðŸš€ **Preview:** ${previewUrl}`;

            const body = pr.data.body || '';
            const newBody = body.includes('ðŸš€ **Preview:**') 
              ? body.replace(/ðŸš€ \*\*Preview:\*\*.+/, `ðŸš€ **Preview:** ${previewUrl}`)
              : body + previewSection;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: newBody
            });
